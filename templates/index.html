<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title or "ATS Resume Optimizer" }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="preload" href="/static/styles.css" as="style" />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="app">
      <!-- â•â•â•â•â•â•â• Top Navigation â•â•â•â•â•â•â• -->
      <nav class="topbar">
        <div class="topbar-brand">
          <span class="logo">âš¡</span>
          <h1>ATS Resume Optimizer</h1>
        </div>
        <div class="topbar-actions">
          <span id="sessionBadge" class="badge badge-neutral" style="display:none">
            Session: <span id="sessionIdDisplay"></span>
          </span>
        </div>
      </nav>

      <!-- â•â•â•â•â•â•â• Dashboard Grid â•â•â•â•â•â•â• -->
      <div class="dashboard">

        <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             â•‘  LEFT PANEL â€” Inputs               â•‘
             â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="panel panel-input">
          <div class="panel-header">
            <h2>ğŸ“„ Input</h2>
          </div>

          <!-- Upload / Paste Resume -->
          <section class="card">
            <h3>Resume Input</h3>
            <!-- Input method toggle -->
            <div class="input-toggle" style="display:flex;gap:0;margin-bottom:.75rem;border:1px solid var(--border);border-radius:8px;overflow:hidden">
              <button type="button" class="input-toggle-btn active" id="toggleFile" onclick="switchInputMethod('file')"
                style="flex:1;padding:.45rem .5rem;font-size:.78rem;font-weight:600;cursor:pointer;border:none;
                       background:var(--accent);color:#fff;transition:all .2s">
                ğŸ“ Upload File
              </button>
              <button type="button" class="input-toggle-btn" id="toggleText" onclick="switchInputMethod('text')"
                style="flex:1;padding:.45rem .5rem;font-size:.78rem;font-weight:600;cursor:pointer;border:none;
                       background:var(--surface);color:var(--text-dim);transition:all .2s">
                âœï¸ Paste / Type
              </button>
            </div>

            <!-- File upload panel -->
            <div id="inputFile">
              <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-upload-area" id="dropZone">
                  <input type="file" id="resume_file" name="file" accept=".pdf,.docx,.doc,.txt,.text" />
                  <p class="file-upload-label">ğŸ“ Drop PDF / DOCX / TXT here or <strong>click to browse</strong></p>
                </div>
                <button type="submit" id="uploadButton" class="btn btn-secondary btn-sm">
                  <span id="uploadButtonText">Upload &amp; Parse</span>
                </button>
              </form>
            </div>

            <!-- Text input panel -->
            <div id="inputText" style="display:none">
              <form id="textForm">
                <textarea id="resume_text" rows="8"
                  placeholder="Paste or type your resume hereâ€¦&#10;&#10;JOHN DOE&#10;john@email.com | (555) 123-4567&#10;&#10;EXPERIENCE&#10;Software Engineer at Company â€” Jan 2023 â€“ Present&#10;â€¢ Built REST APIs using Python/FastAPIâ€¦&#10;&#10;SKILLS&#10;Python, Java, AWS, Dockerâ€¦"
                  style="width:100%;font-size:.8rem;font-family:inherit;resize:vertical"></textarea>
                <button type="submit" id="textButton" class="btn btn-secondary btn-sm">
                  <span id="textButtonText">Parse Resume Text</span>
                </button>
              </form>
            </div>

            <div id="uploadStatus" class="status-msg" style="display:none"></div>
            <div id="resumeSummary" class="resume-summary" style="display:none">
              <div class="summary-grid">
                <div class="summary-item"><span class="summary-num" id="expCount">0</span><span class="summary-label">Experience</span></div>
                <div class="summary-item"><span class="summary-num" id="projCount">0</span><span class="summary-label">Projects</span></div>
                <div class="summary-item"><span class="summary-num" id="skillsCount">0</span><span class="summary-label">Skills</span></div>
                <div class="summary-item"><span class="summary-num" id="certsCount">0</span><span class="summary-label">Certs</span></div>
              </div>
            </div>
          </section>

          <!-- Job Description -->
          <section class="card">
            <h3>Job Description</h3>
            <textarea
              id="job_description"
              rows="10"
              placeholder="Paste the full job description hereâ€¦"
            ></textarea>
            <div class="input-row">
              <input type="text" id="company_name" placeholder="Company name" class="input-sm" />
              <input type="text" id="job_title" placeholder="Job title" class="input-sm" />
            </div>
          </section>

          <!-- Actions -->
          <section class="card action-buttons">
            <button id="analyzeBtn" class="btn btn-primary" onclick="runAnalysis()">
              ğŸ” Analyze ATS Score
            </button>
            <button id="generateBtn" class="btn btn-accent" onclick="generateResume()">
              âœ¨ Generate Tailored Resume
            </button>
            <button id="coverLetterBtn" class="btn btn-outline" onclick="generateCoverLetter()">
              âœ‰ï¸ Generate Cover Letter
            </button>
            <div class="options-row">
              <select id="output_format" class="select-sm">
                <option value="docx">DOCX</option>
                <option value="pdf">PDF (LaTeX)</option>
              </select>
              <label class="checkbox-label">
                <input type="checkbox" id="fast_mode" />
                <span>Fast Mode</span>
              </label>
            </div>
          </section>
        </aside>

        <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             â•‘  CENTER PANEL â€” Analysis            â•‘
             â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="panel panel-results">
          <div class="panel-header">
            <h2>ğŸ“Š Analysis Dashboard</h2>
            <div class="tab-bar">
              <button class="tab active" data-tab="score" onclick="switchTab('score')">Score</button>
              <button class="tab" data-tab="keywords" onclick="switchTab('keywords')">Keywords</button>
              <button class="tab" data-tab="bullets" onclick="switchTab('bullets')">Bullets</button>
              <button class="tab" data-tab="gaps" onclick="switchTab('gaps')">Skill Gaps</button>
              <button class="tab" data-tab="coverletter" onclick="switchTab('coverletter')">Cover Letter</button>
              <button class="tab" data-tab="versions" onclick="switchTab('versions')">Versions</button>
            </div>
          </div>

          <!-- Tab: Score -->
          <div id="tab-score" class="tab-content active">
            <div id="emptyState" class="empty-state">
              <div class="empty-icon">ğŸ“‹</div>
              <h3>Upload your resume &amp; paste a job description</h3>
              <p>Click "Analyze ATS Score" to get a comprehensive compatibility report</p>
            </div>
            <div id="scoreResults" style="display:none">
              <!-- Score Circle -->
              <div class="score-hero">
                <div class="score-circle" id="scoreCircle">
                  <svg viewBox="0 0 120 120">
                    <circle class="score-bg" cx="60" cy="60" r="52" />
                    <circle class="score-fill" id="scoreFill" cx="60" cy="60" r="52" />
                  </svg>
                  <div class="score-text">
                    <span class="score-number" id="scoreNumber">0</span>
                    <span class="score-grade" id="scoreGrade">--</span>
                  </div>
                </div>
                <div class="score-label">ATS Compatibility Score</div>
              </div>

              <!-- Score Breakdown -->
              <div class="breakdown-grid">
                <div class="breakdown-item">
                  <span class="breakdown-label">Keyword Match</span>
                  <span class="breakdown-value" id="val-keyword">0%</span>
                  <div class="breakdown-bar"><div class="breakdown-fill" id="bar-keyword" style="width:0%"></div></div>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">Formatting</span>
                  <span class="breakdown-value" id="val-formatting">0%</span>
                  <div class="breakdown-bar"><div class="breakdown-fill" id="bar-formatting" style="width:0%"></div></div>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">Content Quality</span>
                  <span class="breakdown-value" id="val-content">0%</span>
                  <div class="breakdown-bar"><div class="breakdown-fill" id="bar-content" style="width:0%"></div></div>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">Completeness</span>
                  <span class="breakdown-value" id="val-completeness">0%</span>
                  <div class="breakdown-bar"><div class="breakdown-fill" id="bar-completeness" style="width:0%"></div></div>
                </div>
              </div>

              <!-- Quick Stats -->
              <div class="stats-row">
                <div class="stat-card">
                  <span class="stat-num" id="statKeywordPct">0%</span>
                  <span class="stat-label">Keyword Match</span>
                </div>
                <div class="stat-card">
                  <span class="stat-num" id="statMetrics">0%</span>
                  <span class="stat-label">Bullets w/ Metrics</span>
                </div>
                <div class="stat-card">
                  <span class="stat-num" id="statVerbs">0%</span>
                  <span class="stat-label">Action Verbs</span>
                </div>
                <div class="stat-card">
                  <span class="stat-num" id="statGaps">0</span>
                  <span class="stat-label">Skill Gaps</span>
                </div>
              </div>

              <!-- Recommendations -->
              <div class="recs-section">
                <h3>ğŸ’¡ Top Recommendations</h3>
                <ul id="recsList" class="recs-list"></ul>
              </div>

              <!-- Format Issues -->
              <div class="issues-section">
                <h3>âš ï¸ Format Issues</h3>
                <div id="issuesList" class="issues-list"></div>
              </div>
            </div>
          </div>

          <!-- Tab: Keywords -->
          <div id="tab-keywords" class="tab-content">
            <div id="keywordsEmpty" class="empty-state-sm"><p>Run an analysis to see keyword matches</p></div>
            <div id="keywordsResults" style="display:none">
              <div class="keyword-summary">
                <span class="kw-matched" id="kwMatchedCount">0</span> matched /
                <span class="kw-missing" id="kwMissingCount">0</span> missing of
                <span id="kwTotalCount">0</span> keywords
              </div>
              <div class="keyword-section">
                <h4>âœ… Matched Keywords</h4>
                <div id="matchedKeywords" class="keyword-chips"></div>
              </div>
              <div class="keyword-section">
                <h4>âŒ Missing Keywords</h4>
                <div id="missingKeywords" class="keyword-chips"></div>
              </div>
            </div>
          </div>

          <!-- Tab: Bullets -->
          <div id="tab-bullets" class="tab-content">
            <div id="bulletsEmpty" class="empty-state-sm"><p>Run an analysis to see bullet point improvements</p></div>
            <div id="bulletsResults" style="display:none">
              <div class="bullets-summary"><span id="bulletsTotalCount">0</span> bullets analyzed</div>
              <div id="bulletsList" class="bullets-list"></div>
            </div>
          </div>

          <!-- Tab: Skill Gaps -->
          <div id="tab-gaps" class="tab-content">
            <div id="gapsEmpty" class="empty-state-sm"><p>Run an analysis to see skill gaps</p></div>
            <div id="gapsResults" style="display:none">
              <div id="gapsList" class="gaps-list"></div>
            </div>
          </div>

          <!-- Tab: Cover Letter -->
          <div id="tab-coverletter" class="tab-content">
            <div id="coverLetterEmpty" class="empty-state-sm"><p>Click "Generate Cover Letter" to create a personalized letter</p></div>
            <div id="coverLetterResults" style="display:none">
              <div class="cl-meta">
                <span id="clWordCount">0 words</span>
                <button class="btn btn-sm btn-outline" onclick="copyCoverLetter(this)">ğŸ“‹ Copy</button>
              </div>
              <div id="coverLetterText" class="cover-letter-text"></div>
              <div class="cl-points">
                <h4>Key Points Addressed</h4>
                <ul id="clKeyPoints"></ul>
              </div>
            </div>
          </div>

          <!-- Tab: Versions -->
          <div id="tab-versions" class="tab-content">
            <div id="versionsEmpty" class="empty-state-sm"><p>Generated resumes will appear here for version management</p></div>
            <div id="versionsResults" style="display:none">
              <div id="versionsList" class="versions-list"></div>
            </div>
          </div>
        </main>

        <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             â•‘  RIGHT PANEL â€” Resume Preview       â•‘
             â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="panel panel-preview">
          <div class="panel-header">
            <h2>ğŸ‘ï¸ Resume Preview</h2>
            <div class="preview-toggle">
              <button class="preview-tab active" data-preview="original" onclick="switchPreview('original')">Original</button>
              <button class="preview-tab" data-preview="tailored" onclick="switchPreview('tailored')">Tailored</button>
            </div>
          </div>

          <!-- Original Resume Preview -->
          <div id="preview-original" class="preview-content active">
            <div id="originalPreviewEmpty" class="rp-empty">
              <p>ğŸ“„ Upload a resume to see preview</p>
            </div>
            <div id="originalPreview" class="resume-preview" style="display:none"></div>
          </div>

          <!-- Tailored Resume Preview -->
          <div id="preview-tailored" class="preview-content">
            <div id="tailoredPreviewEmpty" class="rp-empty">
              <p>âœ¨ Generate a tailored resume to see the optimized version</p>
            </div>
            <div id="tailoredPreview" class="resume-preview" style="display:none"></div>
          </div>
        </aside>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         JavaScript
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
      // â”€â”€ State â”€â”€
      let sessionId = null;
      let currentAnalysis = null;
      let resumeData = null;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Input Method Toggle (File â†” Text)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function switchInputMethod(method) {
        const filePanel = document.getElementById('inputFile');
        const textPanel = document.getElementById('inputText');
        const btnFile = document.getElementById('toggleFile');
        const btnText = document.getElementById('toggleText');

        if (method === 'file') {
          filePanel.style.display = 'block';
          textPanel.style.display = 'none';
          btnFile.style.background = 'var(--accent)';
          btnFile.style.color = '#fff';
          btnText.style.background = 'var(--surface)';
          btnText.style.color = 'var(--text-dim)';
        } else {
          filePanel.style.display = 'none';
          textPanel.style.display = 'block';
          btnText.style.background = 'var(--accent)';
          btnText.style.color = '#fff';
          btnFile.style.background = 'var(--surface)';
          btnFile.style.color = 'var(--text-dim)';
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Tab / Preview Switching
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
      }

      function switchPreview(view) {
        document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.preview-content').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-preview="${view}"]`).classList.add('active');
        document.getElementById(`preview-${view}`).classList.add('active');
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Upload
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('uploadForm');
        const dropZone = document.getElementById('dropZone');

        // Drag & drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const file = e.dataTransfer.files[0];
          if (file) {
            document.getElementById('resume_file').files = e.dataTransfer.files;
            uploadForm.dispatchEvent(new Event('submit'));
          }
        });

        uploadForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fileInput = document.getElementById('resume_file');
          const statusDiv = document.getElementById('uploadStatus');
          const btn = document.getElementById('uploadButton');
          const btnText = document.getElementById('uploadButtonText');

          if (!fileInput.files || !fileInput.files[0]) {
            showStatus(statusDiv, 'Please select a file.', 'error');
            return;
          }
          const file = fileInput.files[0];
          if (file.size > 10 * 1024 * 1024) {
            showStatus(statusDiv, 'File too large (max 10MB).', 'error');
            return;
          }

          btn.disabled = true;
          btnText.innerHTML = '<span class="spinner"></span> Parsingâ€¦';
          showStatus(statusDiv, 'Uploading and parsing resumeâ€¦', 'info');

          const formData = new FormData();
          formData.append('file', file);

          try {
            const res = await fetch('/upload_resume/', { method: 'POST', body: formData });
            if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Upload failed'); }
            const data = await res.json();
            handleParseSuccess(data);
          } catch (err) {
            showStatus(statusDiv, `Error: ${err.message}`, 'error');
          } finally {
            btn.disabled = false;
            btnText.textContent = 'Upload & Parse';
            fileInput.value = '';
          }
        });

        // â”€â”€ Text paste/type form â”€â”€
        const textForm = document.getElementById('textForm');
        textForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const textArea = document.getElementById('resume_text');
          const statusDiv = document.getElementById('uploadStatus');
          const btn = document.getElementById('textButton');
          const btnText = document.getElementById('textButtonText');
          const resumeText = textArea.value.trim();

          if (!resumeText) {
            showStatus(statusDiv, 'Please paste or type your resume.', 'error');
            return;
          }
          if (resumeText.length < 50) {
            showStatus(statusDiv, 'Resume text is too short. Please include more detail.', 'error');
            return;
          }

          btn.disabled = true;
          btnText.innerHTML = '<span class="spinner"></span> Parsingâ€¦';
          showStatus(statusDiv, 'Parsing resume textâ€¦', 'info');

          const formData = new FormData();
          formData.append('resume_text', resumeText);

          try {
            const res = await fetch('/upload_resume_text/', { method: 'POST', body: formData });
            if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Parsing failed'); }
            const data = await res.json();
            handleParseSuccess(data);
          } catch (err) {
            showStatus(statusDiv, `Error: ${err.message}`, 'error');
          } finally {
            btn.disabled = false;
            btnText.textContent = 'Parse Resume Text';
          }
        });
      });

      // â”€â”€ Shared success handler for both upload & text input â”€â”€
      function handleParseSuccess(data) {
        const statusDiv = document.getElementById('uploadStatus');
        sessionId = data.session_id;
        showStatus(statusDiv, `âœ“ Parsed: ${data.name}`, 'success');
        document.getElementById('sessionBadge').style.display = 'inline-flex';
        document.getElementById('sessionIdDisplay').textContent = sessionId.substring(0, 8) + 'â€¦';
        document.getElementById('resumeSummary').style.display = 'block';
        document.getElementById('expCount').textContent = data.experience_count;
        document.getElementById('projCount').textContent = data.projects_count;
        document.getElementById('skillsCount').textContent = data.skills_count || 0;
        document.getElementById('certsCount').textContent = data.certifications_count || 0;
        loadResumePreview();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Resume Preview
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function loadResumePreview() {
        if (!sessionId) return;
        try {
          const res = await fetch(`/api/resume_data?session_id=${sessionId}`);
          if (!res.ok) return;
          resumeData = await res.json();
          renderResumePreview('originalPreview', 'originalPreviewEmpty', resumeData, null);
        } catch (e) { /* silent */ }
      }

      function renderResumePreview(containerId, emptyId, data, highlightKeywords) {
        const container = document.getElementById(containerId);
        const empty = document.getElementById(emptyId);
        if (!data) return;

        empty.style.display = 'none';
        container.style.display = 'block';

        const hl = (text) => {
          if (!highlightKeywords || !highlightKeywords.length) return escapeHtml(text);
          let safe = escapeHtml(text);
          for (const kw of highlightKeywords) {
            const regex = new RegExp(`(${escapeRegex(kw)})`, 'gi');
            safe = safe.replace(regex, '<span class="kw-highlight">$1</span>');
          }
          return safe;
        };

        let html = `<div class="rp-header">
          <div class="rp-name">${escapeHtml(data.name || 'Your Name')}</div>
          <div class="rp-contact">
            ${[data.location, data.email, data.phone].filter(Boolean).map(escapeHtml).join(' Â· ')}
            ${data.linkedin ? ' Â· <a href="' + escapeHtml(data.linkedin) + '" target="_blank" style="color:var(--accent)">LinkedIn</a>' : ''}
            ${data.github ? ' Â· <a href="' + escapeHtml(data.github) + '" target="_blank" style="color:var(--accent)">GitHub</a>' : ''}
          </div>
        </div>`;

        // Experience
        if (data.experience && data.experience.length) {
          html += `<div class="rp-section"><div class="rp-section-title">Experience</div>`;
          for (const exp of data.experience) {
            html += `<div class="rp-exp-item">
              <div class="rp-exp-header">
                <span class="rp-exp-title">${hl(exp.title)}</span>
                <span class="rp-exp-dates">${escapeHtml(exp.dates || '')}</span>
              </div>
              <div class="rp-exp-company">${escapeHtml(exp.company || '')}</div>`;
            if (exp.bullets && exp.bullets.length) {
              html += '<ul class="rp-bullets">';
              for (const b of exp.bullets) {
                html += `<li>${hl(b)}</li>`;
              }
              html += '</ul>';
            }
            html += '</div>';
          }
          html += '</div>';
        }

        // Projects
        if (data.projects && data.projects.length) {
          html += `<div class="rp-section"><div class="rp-section-title">Projects</div>`;
          for (const proj of data.projects) {
            html += `<div class="rp-proj-item">
              <span class="rp-exp-title">${hl(proj.name)}</span>
              <p style="font-size:.72rem;color:var(--text-dim);margin:.1rem 0">${hl(proj.description || '')}</p>
              ${proj.technologies && proj.technologies.length ? '<div style="font-size:.65rem;color:var(--text-muted)">Tech: ' + proj.technologies.map(t => hl(t)).join(', ') + '</div>' : ''}
            </div>`;
          }
          html += '</div>';
        }

        // Skills
        if (data.skills && Object.keys(data.skills).length) {
          html += `<div class="rp-section"><div class="rp-section-title">Skills</div><div class="rp-skills-grid">`;
          for (const [cat, skills] of Object.entries(data.skills)) {
            html += `<span class="rp-skill-cat">${escapeHtml(cat)}:</span>
                     <span class="rp-skill-list">${skills.map(s => hl(s)).join(', ')}</span>`;
          }
          html += '</div></div>';
        }

        // Education
        if (data.education && data.education.length) {
          html += `<div class="rp-section"><div class="rp-section-title">Education</div>`;
          for (const edu of data.education) {
            html += `<div class="rp-edu-item">
              <div class="rp-edu-degree">${escapeHtml(edu.degree)}</div>
              <div class="rp-edu-school">${escapeHtml(edu.university || '')} ${edu.dates ? '(' + escapeHtml(edu.dates) + ')' : ''}</div>
              ${edu.coursework && edu.coursework.length ? '<div style="font-size:.65rem;color:var(--text-muted)">Coursework: ' + edu.coursework.map(c => escapeHtml(c)).join(', ') + '</div>' : ''}
            </div>`;
          }
          html += '</div>';
        }

        // Certifications
        if (data.certifications && data.certifications.length) {
          html += `<div class="rp-section"><div class="rp-section-title">Certifications</div>`;
          for (const cert of data.certifications) {
            html += `<div class="rp-cert-item">${escapeHtml(cert.name)} ${cert.issuer ? 'â€” ' + escapeHtml(cert.issuer) : ''} ${cert.year ? '(' + escapeHtml(cert.year) + ')' : ''}</div>`;
          }
          html += '</div>';
        }

        container.innerHTML = html;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ATS Analysis
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function runAnalysis() {
        const jd = document.getElementById('job_description').value.trim();
        if (!jd) { alert('Please paste a job description first.'); return; }
        if (!sessionId) { alert('Please upload a resume first.'); return; }

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Analyzingâ€¦';

        try {
          const formData = new FormData();
          formData.append('job_description', jd);
          formData.append('session_id', sessionId);

          const res = await fetch('/api/analyze', { method: 'POST', body: formData });
          if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Analysis failed'); }
          const data = await res.json();
          currentAnalysis = data;
          renderAnalysis(data);
          switchTab('score');

          // Update tailored preview with keyword highlights
          if (resumeData && data.matched_keywords) {
            renderResumePreview('tailoredPreview', 'tailoredPreviewEmpty', resumeData, data.matched_keywords);
          }
        } catch (err) {
          alert(`Analysis error: ${err.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ” Analyze ATS Score';
        }
      }

      function renderAnalysis(data) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('scoreResults').style.display = 'block';

        // Animate score circle
        const score = data.overall_score;
        const circumference = 2 * Math.PI * 52;
        const offset = circumference - (score / 100) * circumference;
        const fill = document.getElementById('scoreFill');
        fill.style.strokeDasharray = circumference;
        fill.style.strokeDashoffset = circumference;
        requestAnimationFrame(() => {
          requestAnimationFrame(() => { fill.style.strokeDashoffset = offset; });
        });

        let color = '#ef4444';
        if (score >= 80) color = '#10b981';
        else if (score >= 60) color = '#f59e0b';
        fill.style.stroke = color;

        document.getElementById('scoreNumber').textContent = score;
        document.getElementById('scoreGrade').textContent = data.grade;
        document.getElementById('scoreGrade').style.color = color;

        // Breakdown bars
        const bd = data.score_breakdown || {};
        animateBar('keyword', bd.keyword_match || 0);
        animateBar('formatting', bd.formatting || 0);
        animateBar('content', bd.content_quality || 0);
        animateBar('completeness', bd.completeness || 0);

        // Stats
        document.getElementById('statKeywordPct').textContent = data.keyword_match_percentage + '%';
        document.getElementById('statMetrics').textContent = data.bullets_with_metrics_pct + '%';
        document.getElementById('statVerbs').textContent = data.bullets_with_action_verbs_pct + '%';
        document.getElementById('statGaps').textContent = data.skill_gaps ? data.skill_gaps.length : 0;

        // Recommendations
        const recsList = document.getElementById('recsList');
        recsList.innerHTML = '';
        (data.top_recommendations || []).forEach(rec => {
          const li = document.createElement('li');
          li.textContent = rec;
          recsList.appendChild(li);
        });

        // Format Issues
        const issuesList = document.getElementById('issuesList');
        issuesList.innerHTML = '';
        (data.format_issues || []).forEach(issue => {
          const div = document.createElement('div');
          div.className = `issue-item issue-${issue.severity}`;
          div.innerHTML = `<span class="issue-badge">${issue.severity.toUpperCase()}</span>
            <span class="issue-msg">${escapeHtml(issue.message)}</span>
            ${issue.suggestion ? `<span class="issue-fix">${escapeHtml(issue.suggestion)}</span>` : ''}`;
          issuesList.appendChild(div);
        });

        // Render other tabs
        renderKeywords(data);
        renderBullets(data);
        renderGaps(data);
      }

      function animateBar(id, value) {
        const bar = document.getElementById(`bar-${id}`);
        const val = document.getElementById(`val-${id}`);
        bar.style.width = '0%';
        val.textContent = value + '%';
        let color = '#ef4444';
        if (value >= 80) color = '#10b981';
        else if (value >= 60) color = '#f59e0b';
        bar.style.background = color;
        requestAnimationFrame(() => {
          requestAnimationFrame(() => { bar.style.width = value + '%'; });
        });
      }

      function renderKeywords(data) {
        document.getElementById('keywordsEmpty').style.display = 'none';
        document.getElementById('keywordsResults').style.display = 'block';

        const matched = data.matched_keywords || [];
        const missing = data.missing_keywords || [];
        document.getElementById('kwMatchedCount').textContent = matched.length;
        document.getElementById('kwMissingCount').textContent = missing.length;
        document.getElementById('kwTotalCount').textContent = matched.length + missing.length;

        const matchedDiv = document.getElementById('matchedKeywords');
        matchedDiv.innerHTML = '';
        matched.forEach(kw => {
          const span = document.createElement('span');
          span.className = 'chip chip-green';
          span.textContent = kw;
          matchedDiv.appendChild(span);
        });

        const missingDiv = document.getElementById('missingKeywords');
        missingDiv.innerHTML = '';
        missing.forEach(kw => {
          const span = document.createElement('span');
          span.className = 'chip chip-red';
          span.textContent = kw;
          missingDiv.appendChild(span);
        });
      }

      function renderBullets(data) {
        document.getElementById('bulletsEmpty').style.display = 'none';
        document.getElementById('bulletsResults').style.display = 'block';

        const bullets = data.bullet_analyses || [];
        document.getElementById('bulletsTotalCount').textContent = bullets.length;

        const list = document.getElementById('bulletsList');
        list.innerHTML = '';
        bullets.forEach(b => {
          const div = document.createElement('div');
          div.className = 'bullet-item';
          const scoreClass = b.score >= 70 ? 'good' : b.score >= 50 ? 'ok' : 'poor';
          div.innerHTML = `
            <div class="bullet-header">
              <span class="bullet-score ${scoreClass}">${b.score}</span>
              <div class="bullet-badges">
                ${b.has_metrics ? '<span class="mini-badge green">ğŸ“Š Metrics</span>' : '<span class="mini-badge red">No metrics</span>'}
                ${b.has_action_verb ? '<span class="mini-badge green">ğŸ’ª Action verb</span>' : '<span class="mini-badge red">Weak verb</span>'}
              </div>
            </div>
            <p class="bullet-original">"${escapeHtml(b.original.substring(0, 180))}${b.original.length > 180 ? 'â€¦' : ''}"</p>
            ${b.action_verb_suggestion ? `<p class="bullet-suggestion">ğŸ’¡ Try starting with: <strong>${escapeHtml(b.action_verb_suggestion)}</strong></p>` : ''}
            ${b.metric_suggestion ? `<p class="bullet-suggestion">ğŸ“Š ${escapeHtml(b.metric_suggestion)}</p>` : ''}
            ${b.improved && b.improved !== b.original ? `<p class="bullet-improved">âœ¨ <em>${escapeHtml(b.improved.substring(0, 180))}</em></p>` : ''}
          `;
          list.appendChild(div);
        });
      }

      function renderGaps(data) {
        document.getElementById('gapsEmpty').style.display = 'none';
        document.getElementById('gapsResults').style.display = 'block';

        const gaps = data.skill_gaps || [];
        const list = document.getElementById('gapsList');
        list.innerHTML = '';

        if (gaps.length === 0) {
          list.innerHTML = '<div class="empty-state-sm"><p>ğŸ‰ No significant skill gaps found!</p></div>';
          return;
        }

        gaps.forEach(g => {
          const div = document.createElement('div');
          div.className = `gap-item gap-${g.importance}`;
          div.innerHTML = `
            <div class="gap-header">
              <span class="gap-skill">${escapeHtml(g.skill)}</span>
              <span class="gap-badge gap-badge-${g.importance}">${g.importance.toUpperCase()}</span>
            </div>
            ${g.related_skills && g.related_skills.length ? `<p class="gap-related">Related skills you have: ${g.related_skills.map(s => `<strong>${escapeHtml(s)}</strong>`).join(', ')}</p>` : ''}
            <p class="gap-suggestion">${escapeHtml(g.suggestion)}</p>
          `;
          list.appendChild(div);
        });
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Resume Generation
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function generateResume() {
        const jd = document.getElementById('job_description').value.trim();
        if (!jd) { alert('Please paste a job description first.'); return; }

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Generatingâ€¦';

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/generate_resume/';
        form.style.display = 'none';

        const fields = {
          job_description: jd,
          session_id: sessionId || '',
          output_format: document.getElementById('output_format').value,
          fast_mode: document.getElementById('fast_mode').checked ? 'true' : 'false',
        };

        for (const [key, val] of Object.entries(fields)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = val;
          form.appendChild(input);
        }

        document.body.appendChild(form);
        form.submit();

        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = 'âœ¨ Generate Tailored Resume';
          form.remove();
          loadVersions();
        }, 5000);
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Cover Letter
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function generateCoverLetter() {
        const jd = document.getElementById('job_description').value.trim();
        if (!jd) { alert('Please paste a job description first.'); return; }
        if (!sessionId) { alert('Please upload a resume first.'); return; }

        const btn = document.getElementById('coverLetterBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Writingâ€¦';

        try {
          const formData = new FormData();
          formData.append('job_description', jd);
          formData.append('session_id', sessionId);
          formData.append('company_name', document.getElementById('company_name').value);
          formData.append('job_title', document.getElementById('job_title').value);
          formData.append('tone', 'professional');

          const res = await fetch('/api/cover_letter', { method: 'POST', body: formData });
          if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Generation failed'); }
          const data = await res.json();
          renderCoverLetter(data);
          switchTab('coverletter');
        } catch (err) {
          alert(`Error: ${err.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'âœ‰ï¸ Generate Cover Letter';
        }
      }

      function renderCoverLetter(data) {
        document.getElementById('coverLetterEmpty').style.display = 'none';
        document.getElementById('coverLetterResults').style.display = 'block';
        document.getElementById('clWordCount').textContent = data.word_count + ' words';
        document.getElementById('coverLetterText').textContent = data.cover_letter;

        const pts = document.getElementById('clKeyPoints');
        pts.innerHTML = '';
        (data.key_points || []).forEach(p => {
          const li = document.createElement('li');
          li.textContent = p;
          pts.appendChild(li);
        });
      }

      function copyCoverLetter(btn) {
        const text = document.getElementById('coverLetterText').textContent;
        navigator.clipboard.writeText(text).then(() => {
          const original = btn.innerHTML;
          btn.innerHTML = 'âœ… Copied!';
          setTimeout(() => { btn.innerHTML = original; }, 1500);
        });
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Versions
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async function loadVersions() {
        if (!sessionId) return;
        try {
          const res = await fetch(`/api/versions?session_id=${sessionId}`);
          const data = await res.json();
          const versions = data.versions || [];
          if (versions.length) {
            document.getElementById('versionsEmpty').style.display = 'none';
            document.getElementById('versionsResults').style.display = 'block';
            const list = document.getElementById('versionsList');
            list.innerHTML = '';
            versions.reverse().forEach(v => {
              const div = document.createElement('div');
              div.className = 'version-item';
              div.innerHTML = `
                <div class="version-meta">
                  <strong>${escapeHtml(v.job_title || 'Untitled')}</strong>
                  <span class="version-date">${new Date(v.created_at).toLocaleString()}</span>
                </div>
                <div class="version-actions">
                  ${v.ats_score ? `<span class="version-score">${v.ats_score}%</span>` : ''}
                  <a href="/download/${v.filename}" class="btn btn-sm btn-outline">â¬‡ Download</a>
                </div>
              `;
              list.appendChild(div);
            });
          }
        } catch (e) { /* silent */ }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Helpers
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function showStatus(el, msg, type) {
        el.style.display = 'block';
        el.textContent = msg;
        el.className = `status-msg status-${type}`;
      }

      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
      }

      function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }
    </script>
  </body>
</html>
